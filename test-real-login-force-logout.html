<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Test Real Login + Force Logout</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 900px;
        margin: 30px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      h1 {
        color: #333;
        border-bottom: 3px solid #007bff;
        padding-bottom: 10px;
      }
      .status {
        padding: 15px;
        margin: 15px 0;
        border-radius: 5px;
        font-weight: bold;
        text-align: center;
      }
      .logged-in {
        background-color: #d4edda;
        color: #155724;
        border: 2px solid #c3e6cb;
      }
      .logged-out {
        background-color: #f8d7da;
        color: #721c24;
        border: 2px solid #f5c6cb;
      }
      .forced-logout {
        background-color: #fff3cd;
        color: #856404;
        border: 2px solid #ffeaa7;
        animation: pulse 1s infinite;
      }
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
      }
      .section {
        margin: 20px 0;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 5px;
      }
      .form-group {
        margin: 10px 0;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      input {
        padding: 10px;
        width: 100%;
        max-width: 400px;
        font-size: 14px;
        border-radius: 5px;
        border: 1px solid #ddd;
        box-sizing: border-box;
      }
      button {
        padding: 12px 20px;
        margin: 5px;
        font-size: 14px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.3s;
      }
      .btn-primary {
        background-color: #007bff;
        color: white;
      }
      .btn-primary:hover {
        background-color: #0056b3;
      }
      .btn-danger {
        background-color: #dc3545;
        color: white;
      }
      .btn-danger:hover {
        background-color: #c82333;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      #log {
        background-color: #1e1e1e;
        color: #00ff00;
        padding: 15px;
        border-radius: 5px;
        margin-top: 20px;
        max-height: 400px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 12px;
      }
      .log-item {
        padding: 3px;
        border-bottom: 1px solid #333;
      }
      .info-box {
        margin: 20px 0;
        padding: 20px;
        background-color: #e7f3ff;
        border-left: 5px solid #2196F3;
        border-radius: 5px;
      }
      .user-info {
        background: #e8f5e9;
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîê Test Real Login + Force Logout</h1>
      
      <div id="status" class="status logged-out">
        ‚ùå Ch∆∞a ƒëƒÉng nh·∫≠p
      </div>

      <div id="loginSection" class="section">
        <h3>üìù Login Form</h3>
        <div class="form-group">
          <label>Email:</label>
          <input type="email" id="email" placeholder="user@example.com" value="admin@gmail.com" />
        </div>
        <div class="form-group">
          <label>Password:</label>
          <input type="text" id="password" placeholder="password" value="React001" />
        </div>
        <button class="btn-primary" onclick="login()">üîë Login</button>
      </div>

      <div id="userSection" class="section" style="display: none;">
        <h3>üë§ User Information</h3>
        <div id="userInfo" class="user-info"></div>
        <button class="btn-danger" onclick="logout()">üö™ Logout</button>
      </div>

      <div class="section">
        <h3>üìã Console Log:</h3>
        <div id="log"></div>
      </div>

      <div class="info-box">
        <h3>üìù H∆∞·ªõng d·∫´n Test:</h3>
        <ol>
          <li><strong>M·ªü file n√†y tr√™n 2 tab/tr√¨nh duy·ªát</strong></li>
          <li><strong>Tab 1:</strong> Nh·∫≠p email/password ‚Üí Click "Login" ‚Üí ƒêƒÉng nh·∫≠p th√†nh c√¥ng</li>
          <li><strong>Tab 2:</strong> Nh·∫≠p c√πng email/password ‚Üí Click "Login"</li>
          <li><strong>‚ö° Tab 1 s·∫Ω nh·∫≠n ƒë∆∞·ª£c <code>force_logout</code> v√† t·ª± ƒë·ªông ƒëƒÉng xu·∫•t!</strong></li>
        </ol>
        <p><strong>L∆∞u √Ω:</strong> Server ph·∫£i ch·∫°y t·∫°i <code>http://localhost:3000</code></p>
      </div>
    </div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
      const API_URL = 'http://localhost:3000/api';
      let socket = null;
      let accessToken = null;
      let currentUser = null;
      let deviceId = null;

      // L·∫•y ho·∫∑c t·∫°o deviceId t·ª´ localStorage
      function getOrCreateDeviceId() {
        let id = localStorage.getItem('deviceId');
        if (!id) {
          // T·∫°o deviceId duy nh·∫•t cho browser n√†y
          id = 'device_' + Date.now() + '_' + Math.random().toString(36).substring(2, 15);
          localStorage.setItem('deviceId', id);
          addLog(`üÜî ƒê√£ t·∫°o Device ID m·ªõi: ${id}`, 'info');
        } else {
          addLog(`üÜî Device ID t·ª´ localStorage: ${id}`, 'info');
        }
        return id;
      }

      // Helper function ƒë·ªÉ l√†m vi·ªác v·ªõi cookies
      function setCookie(name, value, days = 7) {
        const expires = new Date();
        expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000);
        document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
        addLog(`üç™ ƒê√£ l∆∞u ${name} v√†o cookie`, 'info');
      }

      function getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for(let i = 0; i < ca.length; i++) {
          let c = ca[i];
          while (c.charAt(0) === ' ') c = c.substring(1, c.length);
          if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
      }

      function deleteCookie(name) {
        document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;`;
        addLog(`üóëÔ∏è ƒê√£ x√≥a ${name} kh·ªèi cookie`, 'info');
      }

      function addLog(message, type = 'info') {
        const log = document.getElementById('log');
        const item = document.createElement('div');
        item.className = 'log-item';
        const timestamp = new Date().toLocaleTimeString();
        
        let emoji = '‚ÑπÔ∏è';
        if (type === 'success') emoji = '‚úÖ';
        if (type === 'error') emoji = '‚ùå';
        if (type === 'warning') emoji = '‚ö†Ô∏è';
        if (type === 'logout') emoji = 'üö™';
        
        item.innerHTML = `${emoji} <strong>[${timestamp}]</strong> ${message}`;
        log.appendChild(item);
        log.scrollTop = log.scrollHeight;
      }

      function updateStatus(message, className) {
        const status = document.getElementById('status');
        status.textContent = message;
        status.className = 'status ' + className;
      }

      function showUserSection(user) {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('userSection').style.display = 'block';
        
        const userInfo = document.getElementById('userInfo');
        userInfo.innerHTML = `
          <p><strong>ID:</strong> ${user.id}</p>
          <p><strong>Email:</strong> ${user.email}</p>
          <p><strong>Full Name:</strong> ${user.fullName || 'N/A'}</p>
          <p><strong>Role:</strong> ${user.role?.name || 'N/A'}</p>
        `;
      }

      function showLoginSection() {
        document.getElementById('loginSection').style.display = 'block';
        document.getElementById('userSection').style.display = 'none';
      }

      async function login() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        if (!email || !password) {
          alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p email v√† password!');
          return;
        }

        try {
          addLog(`ƒêang g·ªçi API login v·ªõi email: ${email}...`, 'info');
          
          const response = await fetch(`${API_URL}/auth/login`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email, password }),
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.message || 'Login failed');
          }

          addLog(`‚úÖ Login th√†nh c√¥ng!`, 'success');
          
          // API tr·∫£ v·ªÅ: { status: "success", data: { accessToken, refreshToken } }
          accessToken = data.data.accessToken;
          const refreshToken = data.data.refreshToken;
          
          setCookie('accessToken', accessToken, 7);
          setCookie('refreshToken', refreshToken, 7);
          
          addLog(`üîë AccessToken: ${accessToken.substring(0, 20)}...`, 'info');

          // L·∫•y th√¥ng tin user
          await getUserInfo();

        } catch (error) {
          addLog(`‚ùå Login th·∫•t b·∫°i: ${error.message}`, 'error');
          alert('Login th·∫•t b·∫°i: ' + error.message);
        }
      }

      async function getUserInfo() {
        try {
          addLog('ƒêang l·∫•y th√¥ng tin user...', 'info');
          
          const response = await fetch(`${API_URL}/auth/get-info`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${accessToken}`,
            },
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.message || 'Get user info failed');
          }

          currentUser = data.data;
          addLog(`üë§ User info: ${currentUser.email} (ID: ${currentUser.id})`, 'success');
          
          showUserSection(currentUser);
          updateStatus(`‚úÖ ƒê√£ ƒëƒÉng nh·∫≠p - ${currentUser.email}`, 'logged-in');

          // K·∫øt n·ªëi socket sau khi ƒëƒÉng nh·∫≠p th√†nh c√¥ng
          connectSocket(currentUser.id);

        } catch (error) {
          addLog(`‚ùå Get user info failed: ${error.message}`, 'error');
        }
      }

      function connectSocket(userId) {
        if (socket && socket.connected) {
          addLog('Socket ƒë√£ k·∫øt n·ªëi r·ªìi', 'info');
          return;
        }

        addLog(`üîå ƒêang k·∫øt n·ªëi socket v·ªõi userId: ${userId}...`, 'info');
        socket = io(API_URL.replace('/api', ''));

        socket.on('connect', () => {
          addLog(`‚úÖ Socket connected: ${socket.id}`, 'success');
          
          // QUAN TR·ªåNG: ƒêƒÉng k√Ω userId v√† deviceId v·ªõi socket server
          socket.emit('register_user', { userId, deviceId });
          addLog(`üìù ƒê√£ ƒëƒÉng k√Ω userId ${userId} v√† deviceId ${deviceId} v·ªõi socket server`, 'success');
        });

        // ‚ö° QUAN TR·ªåNG: L·∫Øng nghe force_logout
        socket.on('force_logout', (data) => {
          addLog(`‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è FORCE LOGOUT: ${data.message}`, 'warning');
          updateStatus(`‚ö†Ô∏è ${data.message}`, 'forced-logout');
          
          setTimeout(() => {
            alert('üö® ' + data.message + '\n\nB·∫°n s·∫Ω b·ªã ƒëƒÉng xu·∫•t!');
            handleForceLogout();
          }, 1000);
        });

        socket.on('disconnect', () => {
          addLog('‚ùå Socket disconnected', 'error');
        });

        socket.on('connect_error', (error) => {
          addLog(`‚ùå Socket connection error: ${error.message}`, 'error');
        });
      }

      function handleForceLogout() {
        addLog('üö™ ƒêang th·ª±c hi·ªán logout do force_logout...', 'logout');
        
        // X√≥a tokens t·ª´ cookies
        deleteCookie('accessToken');
        deleteCookie('refreshToken');
        accessToken = null;
        currentUser = null;
        
        // Ng·∫Øt socket
        if (socket) {
          socket.disconnect();
          socket = null;
        }
        
        // Reset UI
        showLoginSection();
        updateStatus('‚ùå ƒê√£ b·ªã ƒëƒÉng xu·∫•t do ƒëƒÉng nh·∫≠p t·ª´ thi·∫øt b·ªã kh√°c', 'logged-out');
        
        addLog('‚úÖ ƒê√£ ƒëƒÉng xu·∫•t ho√†n t·∫•t', 'logout');
      }

      async function logout() {
        try {
          addLog('üö™ ƒêang g·ªçi API logout...', 'logout');
          
          // G·ªçi API logout (protected route, c·∫ßn Authorization header)
          const response = await fetch(`${API_URL}/auth/logout`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${accessToken}`,
              'Content-Type': 'application/json',
            },
          });

          if (response.ok) {
            addLog('‚úÖ API logout th√†nh c√¥ng - Token ƒë√£ ƒë∆∞·ª£c blacklist', 'success');
          } else {
            const data = await response.json();
            addLog(`‚ö†Ô∏è API logout warning: ${data.message || 'Unknown error'}`, 'warning');
          }
          
        } catch (error) {
          addLog(`‚ö†Ô∏è Logout API error: ${error.message}`, 'warning');
        } finally {
          // V·∫´n logout ·ªü client d√π API l·ªói
          deleteCookie('accessToken');
          deleteCookie('refreshToken');
          accessToken = null;
          currentUser = null;
          
          if (socket) {
            socket.disconnect();
            socket = null;
          }
          
          showLoginSection();
          updateStatus('‚ùå ƒê√£ ƒëƒÉng xu·∫•t', 'logged-out');
          addLog('‚úÖ ƒê√£ ƒëƒÉng xu·∫•t ho√†n t·∫•t', 'logout');
        }
      }

      // Check token khi load trang
      window.onload = () => {
        addLog('üöÄ Trang ƒë√£ s·∫µn s√†ng!', 'success');
        
        // Kh·ªüi t·∫°o deviceId
        deviceId = getOrCreateDeviceId();
        
        const savedToken = getCookie('accessToken');
        if (savedToken) {
          accessToken = savedToken;
          addLog('üîë Ph√°t hi·ªán token trong cookie, ƒëang l·∫•y th√¥ng tin user...', 'info');
          getUserInfo();
        } else {
          addLog('üìù Vui l√≤ng ƒëƒÉng nh·∫≠p', 'info');
        }
      };
    </script>
  </body>
</html>
