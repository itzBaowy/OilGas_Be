<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Test Real Login + Force Logout</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 900px;
        margin: 30px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      h1 {
        color: #333;
        border-bottom: 3px solid #007bff;
        padding-bottom: 10px;
      }
      .status {
        padding: 15px;
        margin: 15px 0;
        border-radius: 5px;
        font-weight: bold;
        text-align: center;
      }
      .logged-in {
        background-color: #d4edda;
        color: #155724;
        border: 2px solid #c3e6cb;
      }
      .logged-out {
        background-color: #f8d7da;
        color: #721c24;
        border: 2px solid #f5c6cb;
      }
      .forced-logout {
        background-color: #fff3cd;
        color: #856404;
        border: 2px solid #ffeaa7;
        animation: pulse 1s infinite;
      }
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
      }
      .section {
        margin: 20px 0;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 5px;
      }
      .form-group {
        margin: 10px 0;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      input {
        padding: 10px;
        width: 100%;
        max-width: 400px;
        font-size: 14px;
        border-radius: 5px;
        border: 1px solid #ddd;
        box-sizing: border-box;
      }
      button {
        padding: 12px 20px;
        margin: 5px;
        font-size: 14px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.3s;
      }
      .btn-primary {
        background-color: #007bff;
        color: white;
      }
      .btn-primary:hover {
        background-color: #0056b3;
      }
      .btn-danger {
        background-color: #dc3545;
        color: white;
      }
      .btn-danger:hover {
        background-color: #c82333;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      #log {
        background-color: #1e1e1e;
        color: #00ff00;
        padding: 15px;
        border-radius: 5px;
        margin-top: 20px;
        max-height: 400px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 12px;
      }
      .log-item {
        padding: 3px;
        border-bottom: 1px solid #333;
      }
      .info-box {
        margin: 20px 0;
        padding: 20px;
        background-color: #e7f3ff;
        border-left: 5px solid #2196F3;
        border-radius: 5px;
      }
      .user-info {
        background: #e8f5e9;
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ” Test Real Login + Force Logout</h1>
      
      <div id="status" class="status logged-out">
        âŒ ChÆ°a Ä‘Äƒng nháº­p
      </div>

      <div id="loginSection" class="section">
        <h3>ğŸ“ Login Form</h3>
        <div class="form-group">
          <label>Email:</label>
          <input type="email" id="email" placeholder="user@example.com" value="admin@gmail.com" />
        </div>
        <div class="form-group">
          <label>Password:</label>
          <input type="text" id="password" placeholder="password" value="React001" />
        </div>
        <button class="btn-primary" onclick="login()">ğŸ”‘ Login</button>
      </div>

      <div id="otpSection" class="section" style="display: none;">
        <h3>ğŸ” Verify OTP for New Device</h3>
        <p style="color: #856404;">You are logging in from a new device. Please enter the OTP sent to your email.</p>
        <div class="form-group">
          <label>OTP Code:</label>
          <input type="text" id="otpCode" placeholder="123456" maxlength="6" />
        </div>
        <button class="btn-primary" onclick="verifyOtp()">âœ… Verify OTP</button>
        <button class="btn-danger" onclick="cancelOtp()">âŒ Cancel</button>
      </div>

      <div id="userSection" class="section" style="display: none;">
        <h3>ğŸ‘¤ User Information</h3>
        <div id="userInfo" class="user-info"></div>
        <button class="btn-danger" onclick="logout()">ğŸšª Logout</button>
      </div>

      <div class="section">
        <h3>ğŸ“‹ Console Log:</h3>
        <div id="log"></div>
      </div>

      <div class="info-box">
        <h3>ğŸ“ HÆ°á»›ng dáº«n Test:</h3>
        <ol>
          <li><strong>Má»Ÿ file nÃ y trÃªn Tab 1 (Browser 1):</strong> Nháº­p email/password â†’ Click "Login" â†’ ÄÄƒng nháº­p thÃ nh cÃ´ng</li>
          <li><strong>Má»Ÿ file nÃ y trÃªn Tab 2 hoáº·c Browser khÃ¡c:</strong> Nháº­p cÃ¹ng email/password â†’ Click "Login"</li>
          <li><strong>âš¡ Tab 2 sáº½ yÃªu cáº§u OTP (vÃ¬ Ä‘ang cÃ³ thiáº¿t bá»‹ khÃ¡c online)</strong></li>
          <li><strong>ğŸ“§ Kiá»ƒm tra email â†’ Nháº­p OTP 6 sá»‘ â†’ Click "Verify OTP"</strong></li>
          <li><strong>âœ… Tab 2 Ä‘Äƒng nháº­p thÃ nh cÃ´ng â†’ Tab 1 sáº½ bá»‹ force logout!</strong></li>
          <li><strong>ğŸ”„ Náº¿u login láº¡i trÃªn cÃ¹ng browser/tab â†’ khÃ´ng cáº§n OTP (cÃ¹ng deviceId)</strong></li>
        </ol>
        <p><strong>LÆ°u Ã½:</strong> Server pháº£i cháº¡y táº¡i <code>http://localhost:3000</code></p>
        <p><strong>OTP:</strong> Chá»‰ yÃªu cáº§u khi Ä‘ang cÃ³ device khÃ¡c online. Náº¿u khÃ´ng cÃ³ device nÃ o online â†’ login trá»±c tiáº¿p.</p>
      </div>
    </div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
      const API_URL = 'http://localhost:3000/api';
      let socket = null;
      let accessToken = null;
      let currentUser = null;
      let deviceId = null;
      let pendingOtpData = null; // LÆ°u data khi cáº§n verify OTP

      // Láº¥y hoáº·c táº¡o deviceId tá»« localStorage
      function getOrCreateDeviceId() {
        let id = localStorage.getItem('deviceId');
        if (!id) {
          // Táº¡o deviceId duy nháº¥t cho browser nÃ y
          id = 'device_' + Date.now() + '_' + Math.random().toString(36).substring(2, 15);
          localStorage.setItem('deviceId', id);
          addLog(`ğŸ†” ÄÃ£ táº¡o Device ID má»›i: ${id}`, 'info');
        } else {
          addLog(`ğŸ†” Device ID tá»« localStorage: ${id}`, 'info');
        }
        return id;
      }

      // Helper function Ä‘á»ƒ lÃ m viá»‡c vá»›i cookies
      function setCookie(name, value, days = 7) {
        const expires = new Date();
        expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000);
        document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
        addLog(`ğŸª ÄÃ£ lÆ°u ${name} vÃ o cookie`, 'info');
      }

      function getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for(let i = 0; i < ca.length; i++) {
          let c = ca[i];
          while (c.charAt(0) === ' ') c = c.substring(1, c.length);
          if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
      }

      function deleteCookie(name) {
        document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;`;
        addLog(`ğŸ—‘ï¸ ÄÃ£ xÃ³a ${name} khá»i cookie`, 'info');
      }

      function addLog(message, type = 'info') {
        const log = document.getElementById('log');
        const item = document.createElement('div');
        item.className = 'log-item';
        const timestamp = new Date().toLocaleTimeString();
        
        let emoji = 'â„¹ï¸';
        if (type === 'success') emoji = 'âœ…';
        if (type === 'error') emoji = 'âŒ';
        if (type === 'warning') emoji = 'âš ï¸';
        if (type === 'logout') emoji = 'ğŸšª';
        
        item.innerHTML = `${emoji} <strong>[${timestamp}]</strong> ${message}`;
        log.appendChild(item);
        log.scrollTop = log.scrollHeight;
      }

      function updateStatus(message, className) {
        const status = document.getElementById('status');
        status.textContent = message;
        status.className = 'status ' + className;
      }

      function showUserSection(user) {
        document.getElementById('otpSection').style.display = 'none';
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('userSection').style.display = 'block';
        
        const userInfo = document.getElementById('userInfo');
        userInfo.innerHTML = `
          <p><strong>ID:</strong> ${user.id}</p>
          <p><strong>Email:</strong> ${user.email}</p>
          <p><strong>Full Name:</strong> ${user.fullName || 'N/A'}</p>
          <p><strong>Role:</strong> ${user.role?.name || 'N/A'}</p>
        `;
      }

      function showLoginSection() {
        document.getElementById('otpSection').style.display = 'none';
        document.getElementById('userSection').style.display = 'none';
      }

      function showOtpSection() {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('otpSection').style.display = 'block';
        document.getElementById('userSection').style.display = 'none';
      }

      async function login() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        if (!email || !password) {
          alert('âš ï¸ Vui lÃ²ng nháº­p email vÃ  password!');
          return;
        }

        try {
          addLog(`Äang gá»i API login vá»›i email: ${email}...`, 'info');
          
          const response = await fetch(`${API_URL}/auth/login`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email, password, deviceId }),
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.message || 'Login failed');
          }

          // Kiá»ƒm tra náº¿u cáº§n OTP
          if (data.data.requireOtp) {
            addLog(`âš ï¸ YÃªu cáº§u OTP cho thiáº¿t bá»‹ má»›i`, 'warning');
            addLog(`ğŸ“§ OTP Ä‘Ã£ Ä‘Æ°á»£c gá»­i Ä‘áº¿n email: ${email}`, 'info');
            
            // LÆ°u data Ä‘á»ƒ dÃ¹ng khi verify
            pendingOtpData = { email, deviceId };
            
            showOtpSection();
            updateStatus('â³ Chá» xÃ¡c thá»±c OTP...', 'forced-logout');
            return;
          }

          // Login thÃ nh cÃ´ng khÃ´ng cáº§n OTP
          addLog(`âœ… Login thÃ nh cÃ´ng!`, 'success');
          
          // API tráº£ vá»: { status: "success", data: { accessToken, refreshToken } }
          accessToken = data.data.accessToken;
          const refreshToken = data.data.refreshToken;
          
          setCookie('accessToken', accessToken, 7);
          setCookie('refreshToken', refreshToken, 7);
          
          addLog(`ğŸ”‘ AccessToken: ${accessToken.substring(0, 20)}...`, 'info');

          // Láº¥y thÃ´ng tin user
          await getUserInfo();

        } catch (error) {
          addLog(`âŒ Login tháº¥t báº¡i: ${error.message}`, 'error');
          alert('Login tháº¥t báº¡i: ' + error.message);
        }
      }

      async function verifyOtp() {
        const otp = document.getElementById('otpCode').value;

        if (!otp || otp.length !== 6) {
          alert('âš ï¸ Vui lÃ²ng nháº­p OTP 6 sá»‘!');
          return;
        }

        if (!pendingOtpData) {
          alert('âŒ KhÃ´ng cÃ³ thÃ´ng tin OTP!');
          return;
        }

        try {
          addLog(`Äang xÃ¡c thá»±c OTP...`, 'info');
          
          const response = await fetch(`${API_URL}/auth/verify-device-otp`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              email: pendingOtpData.email,
              deviceId: pendingOtpData.deviceId,
              otp: otp
            }),
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.message || 'OTP verification failed');
          }

          addLog(`âœ… OTP xÃ¡c thá»±c thÃ nh cÃ´ng!`, 'success');

          // LÆ°u tokens
          accessToken = data.data.accessToken;
          const refreshToken = data.data.refreshToken;
          
          setCookie('accessToken', accessToken, 7);
          setCookie('refreshToken', refreshToken, 7);

          // Clear OTP data
          pendingOtpData = null;
          document.getElementById('otpCode').value = '';

          // Láº¥y thÃ´ng tin user
          await getUserInfo();

        } catch (error) {
          addLog(`âŒ OTP verification failed: ${error.message}`, 'error');
          alert('OTP verification failed: ' + error.message);
        }
      }

      function cancelOtp() {
        pendingOtpData = null;
        document.getElementById('otpCode').value = '';
        showLoginSection();
        updateStatus('âŒ ÄÃ£ há»§y xÃ¡c thá»±c', 'logged-out');
        addLog('ÄÃ£ há»§y xÃ¡c thá»±c OTP', 'info');
      }

      async function getUserInfo() {
        try {
          addLog('Äang láº¥y thÃ´ng tin user...', 'info');
          
          const response = await fetch(`${API_URL}/auth/get-info`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${accessToken}`,
            },
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.message || 'Get user info failed');
          }

          currentUser = data.data;
          addLog(`ğŸ‘¤ User info: ${currentUser.email} (ID: ${currentUser.id})`, 'success');
          
          showUserSection(currentUser);
          updateStatus(`âœ… ÄÃ£ Ä‘Äƒng nháº­p - ${currentUser.email}`, 'logged-in');

          // Káº¿t ná»‘i socket sau khi Ä‘Äƒng nháº­p thÃ nh cÃ´ng
          connectSocket(currentUser.id);

        } catch (error) {
          addLog(`âŒ Get user info failed: ${error.message}`, 'error');
        }
      }

      function connectSocket(userId) {
        if (socket && socket.connected) {
          addLog('Socket Ä‘Ã£ káº¿t ná»‘i rá»“i', 'info');
          return;
        }

        addLog(`ğŸ”Œ Äang káº¿t ná»‘i socket vá»›i userId: ${userId}...`, 'info');
        socket = io(API_URL.replace('/api', ''));

        socket.on('connect', () => {
          addLog(`âœ… Socket connected: ${socket.id}`, 'success');
          
          // QUAN TRá»ŒNG: ÄÄƒng kÃ½ userId vÃ  deviceId vá»›i socket server
          socket.emit('register_user', { userId, deviceId });
          addLog(`ğŸ“ ÄÃ£ Ä‘Äƒng kÃ½ userId ${userId} vÃ  deviceId ${deviceId} vá»›i socket server`, 'success');
        });

        // âš¡ QUAN TRá»ŒNG: Láº¯ng nghe force_logout
        socket.on('force_logout', (data) => {
          addLog(`âš ï¸âš ï¸âš ï¸ FORCE LOGOUT: ${data.message}`, 'warning');
          updateStatus(`âš ï¸ ${data.message}`, 'forced-logout');
          
          setTimeout(() => {
            alert('ğŸš¨ ' + data.message + '\n\nBáº¡n sáº½ bá»‹ Ä‘Äƒng xuáº¥t!');
            handleForceLogout();
          }, 1000);
        });

        socket.on('disconnect', () => {
          addLog('âŒ Socket disconnected', 'error');
        });

        socket.on('connect_error', (error) => {
          addLog(`âŒ Socket connection error: ${error.message}`, 'error');
        });
      }

      function handleForceLogout() {
        addLog('ğŸšª Äang thá»±c hiá»‡n logout do force_logout...', 'logout');
        
        // XÃ³a tokens tá»« cookies
        deleteCookie('accessToken');
        deleteCookie('refreshToken');
        accessToken = null;
        currentUser = null;
        
        // Ngáº¯t socket
        if (socket) {
          socket.disconnect();
          socket = null;
        }
        
        // Reset UI
        showLoginSection();
        updateStatus('âŒ ÄÃ£ bá»‹ Ä‘Äƒng xuáº¥t do Ä‘Äƒng nháº­p tá»« thiáº¿t bá»‹ khÃ¡c', 'logged-out');
        
        addLog('âœ… ÄÃ£ Ä‘Äƒng xuáº¥t hoÃ n táº¥t', 'logout');
      }

      async function logout() {
        try {
          addLog('ğŸšª Äang gá»i API logout...', 'logout');
          
          // Gá»i API logout (protected route, cáº§n Authorization header)
          const response = await fetch(`${API_URL}/auth/logout`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${accessToken}`,
              'Content-Type': 'application/json',
            },
          });

          if (response.ok) {
            addLog('âœ… API logout thÃ nh cÃ´ng - Token Ä‘Ã£ Ä‘Æ°á»£c blacklist', 'success');
          } else {
            const data = await response.json();
            addLog(`âš ï¸ API logout warning: ${data.message || 'Unknown error'}`, 'warning');
          }
          
        } catch (error) {
          addLog(`âš ï¸ Logout API error: ${error.message}`, 'warning');
        } finally {
          // Váº«n logout á»Ÿ client dÃ¹ API lá»—i
          deleteCookie('accessToken');
          deleteCookie('refreshToken');
          accessToken = null;
          currentUser = null;
          
          if (socket) {
            socket.disconnect();
            socket = null;
          }
          
          showLoginSection();
          updateStatus('âŒ ÄÃ£ Ä‘Äƒng xuáº¥t', 'logged-out');
          addLog('âœ… ÄÃ£ Ä‘Äƒng xuáº¥t hoÃ n táº¥t', 'logout');
        }
      }

      // Check token khi load trang
      window.onload = () => {
        addLog('ğŸš€ Trang Ä‘Ã£ sáºµn sÃ ng!', 'success');
        
        // Khá»Ÿi táº¡o deviceId
        deviceId = getOrCreateDeviceId();
        
        const savedToken = getCookie('accessToken');
        if (savedToken) {
          accessToken = savedToken;
          addLog('ğŸ”‘ PhÃ¡t hiá»‡n token trong cookie, Ä‘ang láº¥y thÃ´ng tin user...', 'info');
          getUserInfo();
        } else {
          addLog('ğŸ“ Vui lÃ²ng Ä‘Äƒng nháº­p', 'info');
        }
      };
    </script>
  </body>
</html>
