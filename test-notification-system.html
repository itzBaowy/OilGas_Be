<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üîî Test Notification System</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      /* Header v·ªõi Notification Bell */
      .header {
        background: white;
        padding: 20px 30px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .header h1 {
        color: #667eea;
        font-size: 24px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      /* Notification Bell Icon */
      .notification-wrapper {
        position: relative;
      }

      .notification-bell {
        position: relative;
        cursor: pointer;
        background: #f5f5f5;
        border: none;
        padding: 12px;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
      }

      .notification-bell:hover {
        background: #667eea;
        transform: scale(1.1);
      }

      .notification-bell:hover svg {
        fill: white;
      }

      .notification-bell svg {
        width: 24px;
        height: 24px;
        fill: #667eea;
        transition: fill 0.3s;
      }

      .notification-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #ff4757;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: bold;
        border: 2px solid white;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%, 100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }

      /* Notification Dropdown */
      .notification-dropdown {
        position: absolute;
        top: 60px;
        right: 0;
        width: 400px;
        max-height: 600px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        display: none;
        flex-direction: column;
        z-index: 1000;
        animation: slideDown 0.3s ease;
      }

      .notification-dropdown.show {
        display: flex;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .notification-header {
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .notification-header h3 {
        font-size: 18px;
        color: #333;
      }

      .mark-all-read {
        background: none;
        border: none;
        color: #667eea;
        cursor: pointer;
        font-size: 13px;
        text-decoration: underline;
      }

      .mark-all-read:hover {
        color: #764ba2;
      }

      .notification-list {
        flex: 1;
        overflow-y: auto;
        max-height: 450px;
      }

      .notification-item {
        padding: 15px 20px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: background 0.2s;
        position: relative;
      }

      .notification-item:hover {
        background: #f8f9fa;
      }

      .notification-item.unread {
        background: #f0f4ff;
      }

      .notification-item.unread::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background: #667eea;
      }

      .notification-title {
        font-weight: bold;
        color: #333;
        margin-bottom: 5px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .notification-message {
        color: #666;
        font-size: 14px;
        margin-bottom: 5px;
        line-height: 1.4;
      }

      .notification-time {
        color: #999;
        font-size: 12px;
      }

      .notification-type-icon {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
      }

      .type-INFO { background: #3498db; }
      .type-SUCCESS { background: #2ecc71; }
      .type-WARNING { background: #f39c12; }
      .type-ERROR { background: #e74c3c; }
      .type-SYSTEM { background: #9b59b6; }

      .notification-empty {
        padding: 40px 20px;
        text-align: center;
        color: #999;
      }

      .notification-empty svg {
        width: 64px;
        height: 64px;
        margin-bottom: 10px;
        opacity: 0.3;
      }

      .notification-footer {
        padding: 15px 20px;
        border-top: 1px solid #e0e0e0;
        text-align: center;
      }

      .view-all-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.3s;
      }

      .view-all-btn:hover {
        background: #764ba2;
      }

      /* Main Content */
      .main-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .card {
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .card h2 {
        color: #667eea;
        margin-bottom: 20px;
        font-size: 20px;
      }

      /* Status */
      .status {
        padding: 15px;
        border-radius: 10px;
        text-align: center;
        font-weight: bold;
        margin-bottom: 20px;
      }

      .status.logged-in {
        background: #d4edda;
        color: #155724;
        border: 2px solid #c3e6cb;
      }

      .status.logged-out {
        background: #f8d7da;
        color: #721c24;
        border: 2px solid #f5c6cb;
      }

      /* Forms */
      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        color: #555;
        font-weight: 600;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        transition: border 0.3s;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #667eea;
      }

      button {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        margin-right: 10px;
      }

      .btn-primary {
        background: #667eea;
        color: white;
      }

      .btn-primary:hover {
        background: #764ba2;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-success {
        background: #2ecc71;
        color: white;
      }

      .btn-success:hover {
        background: #27ae60;
      }

      .btn-danger {
        background: #e74c3c;
        color: white;
      }

      .btn-danger:hover {
        background: #c0392b;
      }

      /* User Info */
      .user-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
      }

      .user-info p {
        margin: 5px 0;
        color: #555;
      }

      .user-info strong {
        color: #333;
      }

      /* Test Buttons Grid */
      .test-buttons {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-top: 15px;
      }

      .test-buttons button {
        margin: 0;
        padding: 10px;
        font-size: 13px;
      }

      /* Console Log */
      .log-container {
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .log-container h2 {
        color: #667eea;
        margin-bottom: 15px;
      }

      #log {
        background: #1e1e1e;
        color: #00ff00;
        padding: 20px;
        border-radius: 10px;
        max-height: 400px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 12px;
      }

      .log-item {
        padding: 5px;
        border-bottom: 1px solid #333;
        word-wrap: break-word;
      }

      /* Toast Notification */
      .toast {
        position: fixed;
        bottom: 30px;
        right: 30px;
        min-width: 300px;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        display: none;
        animation: slideInRight 0.5s ease;
        z-index: 2000;
      }

      .toast.show {
        display: block;
      }

      @keyframes slideInRight {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .toast-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
      }

      .toast-icon {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
      }

      .toast-title {
        font-weight: bold;
        color: #333;
        flex: 1;
      }

      .toast-close {
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: #999;
        padding: 0;
        margin: 0;
        width: auto;
      }

      .toast-message {
        color: #666;
        font-size: 14px;
        line-height: 1.4;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .main-content {
          grid-template-columns: 1fr;
        }

        .notification-dropdown {
          width: 350px;
        }

        .test-buttons {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header with Notification Bell -->
      <div class="header">
        <h1>
          üîî Notification System
        </h1>
        
        <div class="notification-wrapper">
          <button class="notification-bell" onclick="toggleNotificationDropdown()">
            <svg viewBox="0 0 24 24">
              <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
            </svg>
            <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
          </button>

          <!-- Notification Dropdown -->
          <div id="notificationDropdown" class="notification-dropdown">
            <div class="notification-header">
              <h3>Notifications</h3>
              <button class="mark-all-read" onclick="markAllAsRead()">Mark all as read</button>
            </div>
            
            <div class="notification-list" id="notificationList">
              <div class="notification-empty">
                <svg viewBox="0 0 24 24" fill="#ccc">
                  <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
                </svg>
                <p>No notifications yet</p>
              </div>
            </div>

            <div class="notification-footer">
              <button class="view-all-btn" onclick="viewAllNotifications()">View All</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Login Section -->
        <div class="card">
          <h2>üîê Login</h2>
          <div id="status" class="status logged-out">‚ùå Ch∆∞a ƒëƒÉng nh·∫≠p</div>
          
          <div id="loginForm">
            <div class="form-group">
              <label>Email:</label>
              <input type="email" id="email" placeholder="admin@gmail.com" value="admin@gmail.com" />
            </div>
            <div class="form-group">
              <label>Password:</label>
              <input type="password" id="password" placeholder="Password" value="React001" />
            </div>
            <button class="btn-primary" onclick="login()">üîë Login</button>
          </div>

          <div id="userInfo" style="display: none;">
            <div class="user-info">
              <p><strong>ID:</strong> <span id="userId"></span></p>
              <p><strong>Email:</strong> <span id="userEmail"></span></p>
              <p><strong>Name:</strong> <span id="userName"></span></p>
              <p><strong>Role:</strong> <span id="userRole"></span></p>
            </div>
            <button class="btn-danger" onclick="logout()">üö™ Logout</button>
          </div>
        </div>

        <!-- Test Notification Section -->
        <div class="card">
          <h2>üß™ Test Notifications</h2>
          <p style="color: #666; margin-bottom: 15px;">Send test notifications to yourself:</p>
          
          <div class="test-buttons">
            <button class="btn-primary" onclick="testNotification('INFO')">
              ‚ÑπÔ∏è Info
            </button>
            <button class="btn-success" onclick="testNotification('SUCCESS')">
              ‚úÖ Success
            </button>
            <button class="btn-danger" onclick="testNotification('WARNING')">
              ‚ö†Ô∏è Warning
            </button>
            <button style="background: #e74c3c; color: white;" onclick="testNotification('ERROR')">
              ‚ùå Error
            </button>
            <button style="background: #9b59b6; color: white;" onclick="testNotification('SYSTEM')">
              üîß System
            </button>
            <button style="background: #3498db; color: white;" onclick="testBulkNotifications()">
              üìß Bulk (5x)
            </button>
          </div>

          <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
            <strong>üí° Tip:</strong> Open this page in multiple tabs to see real-time notifications!
          </div>
        </div>
      </div>

      <!-- Send to User Section -->
      <div style="display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 20px;">
        <div class="card">
          <h2>üìß Send Notification to User</h2>
          <p style="color: #666; margin-bottom: 15px;">Enter user email to send notification:</p>
          
          <div class="form-group">
            <label>Recipient Email:</label>
            <input type="email" id="recipientEmail" placeholder="user@example.com" />
          </div>

          <div class="form-group">
            <label>Title:</label>
            <input type="text" id="notifTitle" placeholder="Notification title" value="New Notification" />
          </div>

          <div class="form-group">
            <label>Message:</label>
            <textarea id="notifMessage" placeholder="Enter your message here..." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; min-height: 80px; font-family: inherit;" rows="3">This is a custom notification message.</textarea>
          </div>

          <div class="form-group">
            <label>Type:</label>
            <select id="notifType">
              <option value="INFO">‚ÑπÔ∏è Info</option>
              <option value="SUCCESS">‚úÖ Success</option>
              <option value="WARNING">‚ö†Ô∏è Warning</option>
              <option value="ERROR">‚ùå Error</option>
              <option value="SYSTEM">üîß System</option>
            </select>
          </div>

          <button class="btn-primary" onclick="sendNotificationToUser()" style="width: 100%;">
            üöÄ Send Notification
          </button>

          <div id="sendResult" style="margin-top: 15px; padding: 10px; border-radius: 8px; display: none;"></div>
        </div>
      </div>

      <!-- Console Log -->
      <div class="log-container">
        <h2>üìã Console Log</h2>
        <div id="log"></div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
      <div class="toast-header">
        <div id="toastIcon" class="toast-icon"></div>
        <div id="toastTitle" class="toast-title"></div>
        <button class="toast-close" onclick="hideToast()">√ó</button>
      </div>
      <div id="toastMessage" class="toast-message"></div>
    </div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
      const API_URL = 'http://localhost:3000/api';
      let socket = null;
      let accessToken = null;
      let currentUser = null;
      let deviceId = null;
      let notifications = [];
      let unreadCount = 0;

      // ============ UTILITY FUNCTIONS ============

      function getOrCreateDeviceId() {
        let id = localStorage.getItem('deviceId');
        if (!id) {
          id = 'device_' + Date.now() + '_' + Math.random().toString(36).substring(2, 15);
          localStorage.setItem('deviceId', id);
        }
        return id;
      }

      function setCookie(name, value, days = 7) {
        const expires = new Date();
        expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000);
        document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
      }

      function getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for(let i = 0; i < ca.length; i++) {
          let c = ca[i];
          while (c.charAt(0) === ' ') c = c.substring(1, c.length);
          if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
      }

      function deleteCookie(name) {
        document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;`;
      }

      function addLog(message, type = 'info') {
        const log = document.getElementById('log');
        const item = document.createElement('div');
        item.className = 'log-item';
        const timestamp = new Date().toLocaleTimeString();
        
        let emoji = '‚ÑπÔ∏è';
        if (type === 'success') emoji = '‚úÖ';
        if (type === 'error') emoji = '‚ùå';
        if (type === 'warning') emoji = '‚ö†Ô∏è';
        if (type === 'notification') emoji = 'üîî';
        
        item.innerHTML = `${emoji} <strong>[${timestamp}]</strong> ${message}`;
        log.appendChild(item);
        log.scrollTop = log.scrollHeight;
      }

      function updateStatus(message, className) {
        const status = document.getElementById('status');
        status.textContent = message;
        status.className = 'status ' + className;
      }

      function formatTimeAgo(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const seconds = Math.floor((now - date) / 1000);

        if (seconds < 60) return 'Just now';
        if (seconds < 3600) return `${Math.floor(seconds / 60)} minutes ago`;
        if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
        return `${Math.floor(seconds / 86400)} days ago`;
      }

      // ============ NOTIFICATION FUNCTIONS ============

      function updateNotificationBadge(count) {
        const badge = document.getElementById('notificationBadge');
        unreadCount = count;
        
        if (count > 0) {
          badge.textContent = count > 99 ? '99+' : count;
          badge.style.display = 'flex';
        } else {
          badge.style.display = 'none';
        }
      }

      function renderNotifications() {
        const list = document.getElementById('notificationList');
        
        if (notifications.length === 0) {
          list.innerHTML = `
            <div class="notification-empty">
              <svg viewBox="0 0 24 24" fill="#ccc">
                <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
              </svg>
              <p>No notifications yet</p>
            </div>
          `;
          return;
        }

        const typeEmojis = {
          INFO: '‚ÑπÔ∏è',
          SUCCESS: '‚úÖ',
          WARNING: '‚ö†Ô∏è',
          ERROR: '‚ùå',
          SYSTEM: 'üîß'
        };

        list.innerHTML = notifications.map(notif => `
          <div class="notification-item ${!notif.isRead ? 'unread' : ''}" onclick="markAsRead('${notif.id}')">
            <div class="notification-title">
              <span class="notification-type-icon type-${notif.type}">
                ${typeEmojis[notif.type] || 'üì¨'}
              </span>
              ${notif.title}
            </div>
            <div class="notification-message">${notif.message}</div>
            <div class="notification-time">${formatTimeAgo(notif.createdAt)}</div>
          </div>
        `).join('');
      }

      async function fetchNotifications() {
        try {
          const response = await fetch(`${API_URL}/notifications?page=1&pageSize=20`, {
            headers: {
              'Authorization': `Bearer ${accessToken}`,
            },
          });

          const data = await response.json();
          if (response.ok && data.data?.items) {
            notifications = data.data.items;
            renderNotifications();
            addLog(`Loaded ${notifications.length} notifications`, 'success');
          }
        } catch (error) {
          addLog(`Error fetching notifications: ${error.message}`, 'error');
        }
      }

      async function fetchUnreadCount() {
        try {
          const response = await fetch(`${API_URL}/notifications/unread-count`, {
            headers: {
              'Authorization': `Bearer ${accessToken}`,
            },
          });

          const data = await response.json();
          if (response.ok && data.data) {
            updateNotificationBadge(data.data.unreadCount);
          }
        } catch (error) {
          addLog(`Error fetching unread count: ${error.message}`, 'error');
        }
      }

      async function markAsRead(notificationId) {
        try {
          const response = await fetch(`${API_URL}/notifications/${notificationId}/read`, {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${accessToken}`,
            },
          });

          if (response.ok) {
            // Update local state
            const notif = notifications.find(n => n.id === notificationId);
            if (notif && !notif.isRead) {
              notif.isRead = true;
              updateNotificationBadge(unreadCount - 1);
              renderNotifications();
              addLog('Notification marked as read', 'success');
            }
          }
        } catch (error) {
          addLog(`Error marking as read: ${error.message}`, 'error');
        }
      }

      async function markAllAsRead() {
        try {
          const response = await fetch(`${API_URL}/notifications/read-all`, {
            method: 'PUT',
            headers: {
              'Authorization': `Bearer ${accessToken}`,
            },
          });

          if (response.ok) {
            notifications.forEach(n => n.isRead = true);
            updateNotificationBadge(0);
            renderNotifications();
            addLog('All notifications marked as read', 'success');
            showToast('Success', 'All notifications marked as read', 'SUCCESS');
          }
        } catch (error) {
          addLog(`Error marking all as read: ${error.message}`, 'error');
        }
      }

      function toggleNotificationDropdown() {
        const dropdown = document.getElementById('notificationDropdown');
        dropdown.classList.toggle('show');
        
        if (dropdown.classList.contains('show')) {
          fetchNotifications();
        }
      }

      function viewAllNotifications() {
        addLog('View all notifications clicked', 'info');
        alert('This would navigate to the full notifications page');
      }

      // ============ TOAST FUNCTIONS ============

      function showToast(title, message, type = 'INFO') {
        const toast = document.getElementById('toast');
        const toastIcon = document.getElementById('toastIcon');
        const toastTitle = document.getElementById('toastTitle');
        const toastMessage = document.getElementById('toastMessage');

        const typeEmojis = {
          INFO: { emoji: '‚ÑπÔ∏è', bg: '#3498db' },
          SUCCESS: { emoji: '‚úÖ', bg: '#2ecc71' },
          WARNING: { emoji: '‚ö†Ô∏è', bg: '#f39c12' },
          ERROR: { emoji: '‚ùå', bg: '#e74c3c' },
          SYSTEM: { emoji: 'üîß', bg: '#9b59b6' }
        };

        const typeConfig = typeEmojis[type] || typeEmojis.INFO;
        
        toastIcon.textContent = typeConfig.emoji;
        toastIcon.style.background = typeConfig.bg;
        toastIcon.style.color = 'white';
        toastTitle.textContent = title;
        toastMessage.textContent = message;

        toast.classList.add('show');

        setTimeout(() => {
          hideToast();
        }, 5000);
      }

      function hideToast() {
        document.getElementById('toast').classList.remove('show');
      }

      // ============ AUTH FUNCTIONS ============

      async function login() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        if (!email || !password) {
          alert('Please enter email and password!');
          return;
        }

        try {
          addLog(`Logging in as ${email}...`, 'info');
          
          const response = await fetch(`${API_URL}/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password, deviceId }),
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.message || 'Login failed');
          }

          if (data.data.requireOtp) {
            alert('OTP required! Check your email.');
            return;
          }

          accessToken = data.data.accessToken;
          setCookie('accessToken', accessToken, 7);
          setCookie('refreshToken', data.data.refreshToken, 7);
          
          addLog('Login successful!', 'success');
          await getUserInfo();

        } catch (error) {
          addLog(`Login failed: ${error.message}`, 'error');
          alert('Login failed: ' + error.message);
        }
      }

      async function getUserInfo() {
        try {
          const response = await fetch(`${API_URL}/auth/get-info`, {
            headers: { 'Authorization': `Bearer ${accessToken}` },
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.message || 'Get user info failed');
          }

          currentUser = data.data;
          
          // Update UI
          document.getElementById('loginForm').style.display = 'none';
          document.getElementById('userInfo').style.display = 'block';
          document.getElementById('userId').textContent = currentUser.id;
          document.getElementById('userEmail').textContent = currentUser.email;
          document.getElementById('userName').textContent = currentUser.fullName || 'N/A';
          document.getElementById('userRole').textContent = currentUser.role?.name || 'N/A';
          
          updateStatus(`‚úÖ Logged in - ${currentUser.email}`, 'logged-in');
          addLog(`User info loaded: ${currentUser.email}`, 'success');

          // Connect socket and fetch notifications
          connectSocket(currentUser.id);
          await fetchNotifications();
          await fetchUnreadCount();

        } catch (error) {
          addLog(`Get user info failed: ${error.message}`, 'error');
        }
      }

      async function logout() {
        try {
          await fetch(`${API_URL}/auth/logout`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${accessToken}` },
          });
        } catch (error) {
          addLog(`Logout API error: ${error.message}`, 'warning');
        }

        deleteCookie('accessToken');
        deleteCookie('refreshToken');
        accessToken = null;
        currentUser = null;
        notifications = [];

        if (socket) {
          socket.disconnect();
          socket = null;
        }

        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('userInfo').style.display = 'none';
        updateStatus('‚ùå Logged out', 'logged-out');
        updateNotificationBadge(0);
        renderNotifications();
        addLog('Logged out successfully', 'success');
      }

      // ============ SOCKET FUNCTIONS ============

      function connectSocket(userId) {
        if (socket?.connected) return;

        addLog('Connecting to Socket.IO...', 'info');
        socket = io(API_URL.replace('/api', ''));

        socket.on('connect', () => {
          addLog(`Socket connected: ${socket.id}`, 'success');
          socket.emit('register_user', { userId, deviceId });
          addLog(`Registered user ${userId} with socket`, 'success');
        });

        socket.on('new_notification', (notification) => {
          addLog(`üîî New notification: ${notification.title}`, 'notification');
          
          // Add to list
          notifications.unshift(notification);
          if (notifications.length > 20) notifications.pop();
          
          // Update UI
          renderNotifications();
          updateNotificationBadge(unreadCount + 1);
          
          // Show toast
          showToast(notification.title, notification.message, notification.type);
        });

        socket.on('force_logout', (data) => {
          addLog(`‚ö†Ô∏è Force logout: ${data.message}`, 'warning');
          alert('üö® ' + data.message);
          logout();
        });

        socket.on('disconnect', () => {
          addLog('Socket disconnected', 'warning');
        });

        socket.on('connect_error', (error) => {
          addLog(`Socket error: ${error.message}`, 'error');
        });
      }

      // ============ TEST FUNCTIONS ============

      async function testNotification(type) {
        if (!accessToken) {
          alert('Please login first!');
          return;
        }

        const messages = {
          INFO: { title: 'Information', message: 'This is an informational notification' },
          SUCCESS: { title: 'Success!', message: 'Your action completed successfully' },
          WARNING: { title: 'Warning!', message: 'Please review this important notice' },
          ERROR: { title: 'Error!', message: 'Something went wrong, please try again' },
          SYSTEM: { title: 'System Alert', message: 'System maintenance scheduled for tonight' }
        };

        const config = messages[type];

        try {
          const response = await fetch(`${API_URL}/notifications`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${accessToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              recipientId: currentUser.id,
              title: config.title,
              message: config.message,
              type: type,
              category: 'SYSTEM'
            }),
          });

          if (response.ok) {
            addLog(`Test notification sent: ${type}`, 'success');
          }
        } catch (error) {
          addLog(`Error sending test notification: ${error.message}`, 'error');
        }
      }

      async function testBulkNotifications() {
        if (!accessToken) {
          alert('Please login first!');
          return;
        }

        addLog('Sending 5 bulk notifications...', 'info');

        for (let i = 1; i <= 5; i++) {
          await testNotification(['INFO', 'SUCCESS', 'WARNING', 'ERROR', 'SYSTEM'][i - 1]);
          await new Promise(resolve => setTimeout(resolve, 500));
        }

        addLog('Bulk notifications sent!', 'success');
      }

      async function sendNotificationToUser() {
        if (!accessToken) {
          alert('Please login first!');
          return;
        }

        const email = document.getElementById('recipientEmail').value.trim();
        const title = document.getElementById('notifTitle').value.trim();
        const message = document.getElementById('notifMessage').value.trim();
        const type = document.getElementById('notifType').value;
        const resultDiv = document.getElementById('sendResult');

        if (!email) {
          resultDiv.style.display = 'block';
          resultDiv.style.background = '#fee';
          resultDiv.style.border = '2px solid #e74c3c';
          resultDiv.style.color = '#c0392b';
          resultDiv.innerHTML = '‚ùå Please enter recipient email!';
          return;
        }

        if (!title || !message) {
          resultDiv.style.display = 'block';
          resultDiv.style.background = '#fee';
          resultDiv.style.border = '2px solid #e74c3c';
          resultDiv.style.color = '#c0392b';
          resultDiv.innerHTML = '‚ùå Please enter both title and message!';
          return;
        }

        try {
          addLog(`Sending notification to ${email}...`, 'info');
          
          // G·ª≠i notification theo email (API m·ªõi kh√¥ng c·∫ßn permission VIEW_USER)
          const notifResponse = await fetch(`${API_URL}/notifications/send-by-email`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${accessToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              email: email,
              title: title,
              message: message,
              type: type,
              category: 'USER'
            }),
          });

          const notifData = await notifResponse.json();

          if (notifResponse.ok) {
            const recipientUser = notifData.data.recipient;
            addLog(`‚úÖ Notification sent successfully to ${recipientUser.fullName}!`, 'success');
            
            resultDiv.style.display = 'block';
            resultDiv.style.background = '#d4edda';
            resultDiv.style.border = '2px solid #c3e6cb';
            resultDiv.style.color = '#155724';
            resultDiv.innerHTML = `‚úÖ <strong>Success!</strong><br>Notification sent to ${recipientUser.fullName} (${email})`;
            
            showToast('Success!', `Notification sent to ${recipientUser.fullName}`, 'SUCCESS');
          } else {
            throw new Error(notifData.message || 'Failed to send notification');
          }

        } catch (error) {
          addLog(`‚ùå Error: ${error.message}`, 'error');
          
          resultDiv.style.display = 'block';
          resultDiv.style.background = '#fee';
          resultDiv.style.border = '2px solid #e74c3c';
          resultDiv.style.color = '#c0392b';
          resultDiv.innerHTML = `‚ùå <strong>Error:</strong><br>${error.message}`;
          
          showToast('Error', error.message, 'ERROR');
        }
      }

      // ============ INITIALIZATION ============

      window.onload = () => {
        addLog('üöÄ Page loaded successfully!', 'success');
        
        deviceId = getOrCreateDeviceId();
        addLog(`Device ID: ${deviceId}`, 'info');
        
        const savedToken = getCookie('accessToken');
        if (savedToken) {
          accessToken = savedToken;
          addLog('Found saved token, loading user info...', 'info');
          getUserInfo();
        } else {
          addLog('Please login to continue', 'info');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
          const dropdown = document.getElementById('notificationDropdown');
          const bell = document.querySelector('.notification-bell');
          if (!dropdown.contains(e.target) && !bell.contains(e.target)) {
            dropdown.classList.remove('show');
          }
        });
      };
    </script>
  </body>
</html>
